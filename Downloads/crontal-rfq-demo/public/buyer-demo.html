<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crontal ¬∑ Buyer & Supplier RFQ Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { accent: '#5a7baa' }
        }
      }
    }
  </script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- üëá ADD THIS: jsPDF AutoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>  
    <!-- Custom styles for dark theme -->
  <!-- Dark theme overrides + loading animation -->
<!-- Light, modern theme + subtle interactions -->
<style>
/* ------------------------------------------------------------
   CRONTAL RFQ DEMO ‚Äì LIGHT THEME & INTERACTIONS
------------------------------------------------------------- */

/* Global background + text */
body {
  background:
    radial-gradient(circle at top left, #dde8ff 0, #f4f6fc 45%, #ffffff 100%);
  color: #0f172a;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

/* Keep cards clean and elevated */
.rounded-2xl.border.bg-white {
  background-color: #ffffff;
  border-color: #e2e8f0;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
  transition:
    transform 150ms ease-out,
    box-shadow 150ms ease-out,
    border-color 150ms ease-out,
    background-color 150ms ease-out;
}

.rounded-2xl.border.bg-white:hover {
  transform: translateY(-2px);
  box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
  border-color: #c7d2fe;
  background-color: #fdfdff;
}

/* Header pills & chips */
.inline-flex.rounded-full.bg-white.border {
  background-color: rgba(255, 255, 255, 0.9) !important;
  border-color: #e2e8f0 !important;
  box-shadow: 0 4px 12px rgba(148, 163, 184, 0.25);
}

/* Accent color adjustments */
.bg-accent\/10 {
  background-color: rgba(90, 123, 170, 0.12) !important;
}

.text-accent {
  color: #325ea5 !important;
}

.border-accent {
  border-color: #5a7baa !important;
}

/* Primary buttons ‚Äì slight lift & glow */
button.border-accent {
  transition:
    background-color 120ms ease-out,
    transform 120ms ease-out,
    box-shadow 120ms ease-out,
    border-color 120ms ease-out;
}

button.border-accent:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
  border-color: #3b82f6;
}

/* Priority pills */
.priority-active {
  background-color: rgba(90, 123, 170, 0.16) !important;
  color: #325ea5 !important;
  border-color: #325ea5 !important;
}

/* Chat window ‚Äì lighter, airy */
#chat-window {
  background-color: #f9fafb !important;
  border-color: #e5e7eb !important;
}

/* Chat bubbles ‚Äì soften colors a bit */
#chat-window .bg-accent\/10 {
  background-color: rgba(90, 123, 170, 0.15) !important;
}

#chat-window .bg-white.border.border-slate-200 {
  background-color: #ffffff !important;
  border-color: #e5e7eb !important;
}

/* Supplier preview card */
#supplier-preview-card {
  background-color: #f3f6ff !important;
  border-color: #c7d2fe !important;
  color: #111827 !important;
}

/* Tables ‚Äì cleaner header */
table {
  background-color: #ffffff;
  color: #111827;
}

thead {
  background-color: #f3f4f6;
  color: #6b7280;
}

tbody tr {
  border-color: #e5e7eb;
}

/* Supplier quote cards */
#quotes-list .border-slate-200 {
  border-color: #e5e7eb !important;
}

#quotes-list .bg-white {
  background-color: #ffffff !important;
}

#quotes-list .bg-accent\/10 {
  background-color: rgba(90, 123, 170, 0.12) !important;
}

/* PDF modal overlay */
#pdf-modal {
  background-color: rgba(15, 23, 42, 0.5) !important;
}

#pdf-modal .bg-white {
  background-color: #ffffff !important;
  color: #0f172a !important;
}

/* Input & textarea styling */
input,
textarea,
select {
  background-color: #ffffff !important;
  color: #111827 !important;
  border-color: #d1d5db !important;
}

input::placeholder,
textarea::placeholder {
  color: #9ca3af !important;
}

/* Hover & focus states for inputs */
input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: #93c5fd !important;
  box-shadow: 0 0 0 1px rgba(147, 197, 253, 0.6);
}

/* Subtle section dividers */
hr {
  border-color: #e5e7eb;
}

/* ------------------------------------------------------------
   CHAT LOADING ANIMATION (three bouncing dots)
------------------------------------------------------------- */

.loading-dots {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  margin-left: 4px;
}

.loading-dots .dot {
  width: 4px;
  height: 4px;
  border-radius: 999px;
  background-color: #9ca3af;
  animation: dotBounce 1s infinite ease-in-out;
}

.loading-dots .dot:nth-child(2) {
  animation-delay: 0.15s;
}
.loading-dots .dot:nth-child(3) {
  animation-delay: 0.3s;
}

@keyframes dotBounce {
  0%, 80%, 100% {
    transform: translateY(0);
    opacity: 0.5;
  }
  40% {
    transform: translateY(-2px);
    opacity: 1;
  }
}

/* ------------------------------------------------------------
   SMALL INTERACTIONS FOR SECTIONS
------------------------------------------------------------- */

/* Slight highlight when hovering entire buyer/supplier panels */
main#buyer-view > section,
main#supplier-view > section {
  transition: transform 150ms ease-out;
}

main#buyer-view > section:hover,
main#supplier-view > section:hover {
  transform: translateY(-1px);
}

/* Link field aesthetic */
#share-link-input {
  background-color: #f9fafb !important;
}

/* Award email area ‚Äì make it stand out a bit more */
#rfp-output {
  background: linear-gradient(135deg, #f9fafb 0%, #f3f4ff 40%, #ffffff 100%) !important;
  border-color: #c7d2fe !important;
}
</style>


</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8 md:py-10">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-accent/10 border border-accent flex items-center justify-center">
          <span class="text-accent font-semibold text-lg">C</span>
        </div>
        <div>
          <div class="flex items-center gap-2">
            <h1 class="text-xl md:text-2xl font-semibold tracking-tight text-slate-900">Crontal</h1>
            <span class="inline-flex items-center rounded-full border border-slate-200 px-2 py-0.5 text-[11px] uppercase tracking-wide text-slate-500 bg-white">
              RFQ demo
            </span>
          </div>
          <p class="text-xs md:text-sm text-slate-500 mt-1">
            Chat with Crontal to turn your RFQ into a structured table and supplier quotes.
          </p>
        </div>
      </div>

      <!-- View toggle -->
      <div class="flex items-center gap-3">
        <div class="inline-flex rounded-full bg-white border border-slate-200 p-1 text-[11px] shadow-sm">
          <button
            id="toggle-buyer"
            class="px-3 py-1.5 rounded-full bg-accent/10 border border-accent text-accent font-medium"
          >
            Buyer view
          </button>
          <button
            id="toggle-supplier"
            class="px-3 py-1.5 rounded-full text-slate-600 hover:text-accent hover:bg-accent/5"
          >
            Supplier view
          </button>
        </div>
      </div>
    </header>

    <!-- BUYER VIEW -->
    <main id="buyer-view" class="mt-8 grid gap-6 md:grid-cols-2">
      <!-- Left: conversational RFQ builder -->
      <section class="space-y-4">
      <!-- NEW: File upload ‚Üí parse specs into line items -->
        <div class="rounded-2xl border bg-white p-4 md:p-5 shadow-sm flex flex-col text-xs">
        <div class="flex items-center justify-between gap-3 pb-2 border-b border-slate-200">
            <div>
            <h2 class="text-sm font-semibold tracking-tight text-slate-900">
                Upload design / spec files
            </h2>
            <p class="mt-1 text-xs text-slate-500">
                Upload engineering PDFs and Excel tech specs to auto-generate line items.
            </p>
            </div>
        </div>

        <div class="mt-3 space-y-2">
            <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500 mb-1 block">
                Files
            </label>
            <input
                id="file-upload-input"
                type="file"
                multiple
                class="text-xs text-slate-800"
                accept=".pdf,.xls,.xlsx,.csv,.txt"
            />
            <p class="text-[11px] text-slate-500 mt-1">
                Supported now: engineering PDFs (.pdf) and tech spec spreadsheets (.xls, .xlsx). Max 5 files per run.
            </p>
            </div>

            <div class="flex items-center gap-2 mt-2">
            <button
                id="file-upload-btn"
                class="rounded-xl border border-accent bg-accent/5 px-3 py-1.5 text-[11px] text-accent font-medium hover:bg-accent/10 transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Parse files into line items
            </button>
            <p id="file-upload-status" class="text-[11px] text-slate-500"></p>
            </div>
        </div>
        </div>

        <div class="rounded-2xl border bg-white p-4 md:p-5 shadow-sm flex flex-col">
          <div class="flex items-center justify-between gap-3 pb-3 border-b border-slate-200">
            <div>
              <h2 class="text-sm font-semibold tracking-tight text-slate-900">
                Buyer ¬∑ RFQ conversation
              </h2>
              <p class="mt-1 text-xs text-slate-500">
                Chat with Crontal. It will parse your description into the table on the right and help you refine it.
              </p>
            </div>
            <div class="text-right text-[11px] text-slate-500">
              <span class="block uppercase tracking-wide text-slate-400">Role</span>
              <span class="font-medium">Industrial buyer</span>
            </div>
          </div>

          <div class="mt-3 text-xs flex flex-col gap-2">
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
              Conversation
            </label>

            <div
              id="chat-window"
              class="h-72 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 space-y-2 overflow-y-auto"
            ></div>

            <div class="mt-2 flex items-center gap-2">
              <input
                id="chat-input"
                type="text"
                class="flex-1 rounded-xl border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-accent"
                placeholder="Describe what you need, or reply to Crontal..."
              />
              <button
                id="chat-send-btn"
                class="rounded-xl border border-accent bg-accent/5 px-3 py-1.5 text-[11px] text-accent font-medium hover:bg-accent/10 transition"
              >
                Send
              </button>
            </div>
          </div>
        </div>

        <!-- Buyer: Share link + RFP draft -->
        <div class="rounded-2xl border bg-white p-4 md:p-5 text-xs space-y-3 shadow-sm">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-[11px] uppercase tracking-wide text-slate-500">Share with suppliers</p>
              <p class="text-slate-700" id="share-link-label">
                Start a conversation to get a structured request and link you can send to suppliers.
              </p>
            </div>
          </div>

          <div id="share-link-block" class="mt-2 hidden">
            <label class="text-[11px] uppercase tracking-wide text-slate-500">Request link (demo)</label>
            <div class="mt-1 flex items-center gap-2">
              <input
                id="share-link-input"
                type="text"
                readonly
                class="flex-1 rounded-xl px-3 py-1.5 text-[11px] text-slate-700 font-mono"
              />
              <button
                id="copy-link-btn"
                class="rounded-lg border border-slate-300 bg-white px-2.5 py-1 text-[11px] text-slate-600 hover:border-accent hover:text-accent hover:bg-accent/5 transition"
              >
                Copy
              </button>
            </div>
            <p class="mt-1 text-[11px] text-slate-500">
              In production, your supplier would open this link and see the structured request on their side.
            </p>
          </div>

          <div class="mt-4 pt-4 border-t border-slate-200">
            <div class="flex items-center justify-between gap-2 mb-2">
                <div>
                <p class="text-[11px] uppercase tracking-wide text-slate-500">
                    Award email to selected supplier
                </p>
                <p class="text-[11px] text-slate-500">
                    This email will announce the award and reference the attached PDF RFP document.
                </p>
                </div>
                <button
                id="generate-rfp-btn"
                class="rounded-lg border border-accent bg-accent/10 px-3 py-1.5 text-[11px] text-accent font-medium hover:bg-accent/20 transition"
                >
                Generate award email
                </button>
            </div>

            <textarea
                id="rfp-output"
                class="mt-2 h-48 md:h-56 w-full rounded-xl px-3 py-2 text-xs md:text-[13px] leading-relaxed bg-slate-950/40 border border-accent/40 focus:outline-none focus:ring-1 focus:ring-accent"
                placeholder="The award email to the selected supplier will appear here after you click ‚ÄúGenerate award email‚Äù. You can copy/paste or edit before sending."
            ></textarea>
            </div>

        </div>
      </section>

      <!-- Right: structured request + supplier responses -->
      <!-- Right: structured request + supplier responses -->
        <section class="space-y-4">
        <!-- NEW: Project / package info (EPC style) -->
        <div class="rounded-2xl border bg-white p-4 md:p-5 text-xs shadow-sm">
            <div class="flex items-center justify-between gap-3 mb-2">
            <div>
                <p class="text-[11px] uppercase tracking-wide text-slate-500">
                Project &amp; package
                </p>
                <h3 class="text-sm font-semibold text-slate-900">
                EPC project context
                </h3>
                <p class="mt-1 text-[11px] text-slate-500">
                Capture the project and package this RFQ belongs to. This helps frame supplier quotes in the right context.
                </p>
            </div>
            </div>

            <div class="grid gap-3 md:grid-cols-2 mt-2">
            <div>
                <label class="text-[11px] uppercase tracking-wide text-slate-500">
                Project name
                </label>
                <input
                id="project-name-input"
                type="text"
                class="mt-1 w-full rounded-xl border px-3 py-1.5 text-xs"
                placeholder="e.g. XYZ Gas Processing Plant"
                />
            </div>
            <div>
                <label class="text-[11px] uppercase tracking-wide text-slate-500">
                Client
                </label>
                <input
                id="project-client-input"
                type="text"
                class="mt-1 w-full rounded-xl border px-3 py-1.5 text-xs"
                placeholder="e.g. ABC Oil &amp; Gas"
                />
            </div>
            </div>

            <div class="grid gap-3 md:grid-cols-3 mt-3">
            <div>
                <label class="text-[11px] uppercase tracking-wide text-slate-500">
                Package ID
                </label>
                <input
                id="project-package-input"
                type="text"
                class="mt-1 w-full rounded-xl border px-3 py-1.5 text-xs"
                placeholder="e.g. PKG-PIPING-0101"
                />
            </div>
            <div>
                <label class="text-[11px] uppercase tracking-wide text-slate-500">
                Revision
                </label>
                <input
                id="project-revision-input"
                type="text"
                class="mt-1 w-full rounded-xl border px-3 py-1.5 text-xs"
                placeholder="e.g. Rev 0"
                />
            </div>
            <div>
                <label class="text-[11px] uppercase tracking-wide text-slate-500">
                Stage
                </label>
                <input
                id="project-stage-input"
                type="text"
                class="mt-1 w-full rounded-xl border px-3 py-1.5 text-xs"
                placeholder="e.g. Detail design"
                />
            </div>
            </div>
        </div>

        <!-- Structured request -->
        <div class="rounded-2xl border bg-white p-4 md:p-5 text-xs shadow-sm">
          <div class="flex items-center justify-between gap-3 mb-3">
            <div>
              <h3 class="text-sm font-semibold text-slate-900">
                Structured product request
              </h3>
              <p class="mt-1 text-xs text-slate-500">
                Parsed from your conversation (via backend). You can still edit fields below.
              </p>
            </div>
            <div class="text-right text-xs">
              <p class="text-[11px] uppercase tracking-wide text-slate-500">Request ID</p>
              <p id="request-id-label" class="mt-0.5 text-slate-700 font-medium">
                None yet
              </p>
            </div>
          </div>

          <div id="buyer-request-empty" class="text-[11px] text-slate-500">
            No conversation yet. Start chatting on the left to generate a structured request.
          </div>

          <div id="buyer-request-block" class="hidden space-y-3">
            <!-- Line items -->
            <div>
              <p class="text-[11px] uppercase tracking-wide text-slate-500 mb-1">
                Line items (editable)
              </p>
              <div class="overflow-x-auto rounded-xl border border-slate-200 bg-slate-50">
                <table class="min-w-full text-[11px]">
                  <thead class="bg-slate-100 text-slate-500">
                    <tr>
                        <th class="px-3 py-2 text-left font-normal">Line</th>
                        <th class="px-3 py-2 text-left font-normal">Description</th>
                        <th class="px-3 py-2 text-left font-normal">Discipline</th>
                        <th class="px-3 py-2 text-left font-normal">Commodity</th>
                        <th class="px-3 py-2 text-left font-normal">Shape</th>
                        <th class="px-3 py-2 text-left font-normal">Grade</th>
                        <th class="px-3 py-2 text-left font-normal">Qty</th>
                        <th class="px-3 py-2 text-left font-normal">UoM</th>
                        <th class="px-3 py-2 text-left font-normal">WT</th>
                        <th class="px-3 py-2 text-left font-normal">Diameter</th>
                        <th class="px-3 py-2 text-left font-normal">Length</th>
                    </tr>
                  </thead>

                  <tbody id="buyer-items-body" class="divide-y divide-slate-200 text-slate-800">
                    <!-- injected -->
                  </tbody>
                </table>
              </div>
              <p class="mt-1 text-[11px] text-slate-500">
                Editing these fields updates the request used for the supplier view and RFP export.
              </p>
            </div>

            <!-- Commercial terms -->
            <div class="grid gap-3 md:grid-cols-3">
              <div class="rounded-xl bg-slate-50 border border-slate-200 p-3">
                <p class="text-[11px] uppercase tracking-wide text-slate-500">Destination</p>
                <p id="buyer-destination" class="mt-1 text-slate-800">‚Äì</p>
              </div>
              <div class="rounded-xl bg-slate-50 border border-slate-200 p-3">
                <p class="text-[11px] uppercase tracking-wide text-slate-500">Incoterm</p>
                <p id="buyer-incoterm" class="mt-1 text-slate-800">‚Äì</p>
              </div>
              <div class="rounded-xl bg-slate-50 border border-slate-200 p-3">
                <p class="text-[11px] uppercase tracking-wide text-slate-500">Payment terms</p>
                <p id="buyer-payment" class="mt-1 text-slate-800">‚Äì</p>
              </div>
            </div>

            <!-- Other requirements -->
            <div class="rounded-xl bg-slate-50 border border-slate-200 p-3">
              <p class="text-[11px] uppercase tracking-wide text-slate-500 mb-1">
                Other requirements (optional)
              </p>
              <textarea
                id="buyer-other-req"
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
                placeholder="Documentation, standards, QA/inspection, packaging, special notes..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Supplier responses with priority toggle -->
        <div class="rounded-2xl border bg-white p-4 md:p-5 text-xs mt-2 shadow-sm">
          <div class="flex items-start justify-between gap-3 mb-3">
            <div>
              <h3 class="text-sm font-semibold text-slate-900">
                Supplier responses
              </h3>
              <p class="mt-1 text-xs text-slate-500">
                Ranked based on your selected priority.
              </p>
            </div>
            <div class="flex flex-col items-end gap-1">
              <div class="text-right text-xs">
                <p class="text-[11px] uppercase tracking-wide text-slate-500">Count</p>
                <p id="quotes-count" class="mt-0.5 text-slate-700 font-medium">0</p>
              </div>
              <div class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[10px] gap-1">
                <span class="text-slate-500 mr-1">Rank by:</span>
                <button id="priority-pricing"  class="px-2 py-0.5 rounded-full border border-transparent text-slate-600 priority-active">
                  Pricing
                </button>
                <button id="priority-delivery" class="px-2 py-0.5 rounded-full border border-transparent text-slate-600 hover:text-accent hover:border-accent/40">
                  Delivery
                </button>
                <button id="priority-payment"  class="px-2 py-0.5 rounded-full border border-transparent text-slate-600 hover:text-accent hover:border-accent/40">
                  Payment terms
                </button>
              </div>
            </div>
          </div>

          <div id="quotes-empty" class="text-[11px] text-slate-500">
            No supplier quotes yet. Toggle to Supplier view to submit a quote.
          </div>

          <div id="quotes-list" class="hidden space-y-2">
            <!-- quote cards injected by JS -->
          </div>
        </div>
      </section>
    </main>

    <!-- SUPPLIER VIEW -->
    <!-- SUPPLIER VIEW ‚Äì stacked full-width layout -->
    <main id="supplier-view" class="mt-8 flex flex-col gap-6 hidden">
    <!-- Supplier: request viewer + line items -->
    <section class="rounded-2xl border bg-white p-4 md:p-5 shadow-sm text-xs">
        <div class="flex items-center justify-between gap-3 pb-3 border-b border-slate-200">
        <div>
            <h2 class="text-sm font-semibold tracking-tight text-slate-900">
            Supplier ¬∑ Quote against request
            </h2>
            <p class="mt-1 text-xs text-slate-500">
            Review the structured request and enter your pricing and terms.
            </p>
        </div>
        <div class="text-right text-[11px] text-slate-500">
            <span class="block uppercase tracking-wide text-slate-400">Role</span>
            <span>Mill / service center</span>
        </div>
        </div>

        <div class="mt-3 space-y-3">
        <div class="flex items-center justify-between gap-2">
            <p class="text-[11px] uppercase tracking-wide text-slate-500">
            Loaded request
            </p>
            <p id="supplier-request-id" class="text-[11px] text-slate-700">
            None yet
            </p>
        </div>

        <div id="supplier-request-empty" class="text-[11px] text-slate-500">
            No active request. Go to Buyer view and start a conversation.
        </div>

        <div id="supplier-request-block" class="hidden space-y-2">
            <div class="rounded-xl bg-slate-50 border border-slate-200 p-3">
            <p class="text-[11px] uppercase tracking-wide text-slate-500 mb-1">
                Request summary
            </p>
            <p id="supplier-request-summary" class="text-slate-800"></p>
            </div>

            <div class="overflow-x-auto overflow-y-auto rounded-xl border border-slate-200 bg-slate-50">
            <table class="min-w-full text-[11px]">
                <thead class="bg-slate-100 text-slate-500">
                <tr>
                    <th class="px-3 py-2 text-left font-normal">Line</th>
                    <th class="px-3 py-2 text-left font-normal">Description</th>
                    <th class="px-3 py-2 text-left font-normal">Grade</th>
                    <th class="px-3 py-2 text-left font-normal">Size / Spec</th>
                    <th class="px-3 py-2 text-left font-normal">Qty</th>
                    <th class="px-3 py-2 text-left font-normal">UoM</th>
                    <th class="px-3 py-2 text-left font-normal">Unit price</th>
                </tr>
                </thead>
                <tbody id="supplier-items-body" class="divide-y divide-slate-200 text-slate-800">
                <!-- injected by JS -->
                </tbody>
            </table>
            </div>
        </div>
        </div>
    </section>

    <!-- Supplier: quote meta -->
    <section class="rounded-2xl border bg-white p-4 md:p-5 text-xs space-y-3 shadow-sm">
        <div class="grid gap-3 md:grid-cols-2">
        <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Supplier name
            </label>
            <input
            id="supplier-name-input"
            type="text"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            placeholder="Example: Mill A ¬∑ East Asia"
            />
        </div>
        <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Currency
            </label>
            <select
            id="supplier-currency-input"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            >
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="CNY">CNY</option>
            </select>
        </div>
        </div>

        <div class="grid gap-3 md:grid-cols-2">
        <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Contact email
            </label>
            <input
            id="supplier-email-input"
            type="email"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            placeholder="sales@mill.com"
            />
        </div>
        <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Contact phone
            </label>
            <input
            id="supplier-phone-input"
            type="tel"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            placeholder="+1 555 123 4567"
            />
        </div>
        </div>

        <div class="grid gap-3 md:grid-cols-3">
        <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Lead time (days)
            </label>
            <input
            id="supplier-leadtime-input"
            type="number"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            placeholder="e.g. 30"
            />
        </div>
        <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Payment terms
            </label>
            <input
            id="supplier-payment-input"
            type="text"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            placeholder="e.g. Net 30"
            />
        </div>
        <div>
            <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Quote validity (days)
            </label>
            <input
            id="supplier-validity-input"
            type="number"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            placeholder="e.g. 15"
            />
        </div>
        </div>

        <div>
        <label class="text-[11px] uppercase tracking-wide text-slate-500">
            Notes / conditions
        </label>
        <textarea
            id="supplier-notes-input"
            class="mt-1 h-20 w-full rounded-xl border border-slate-300 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-accent"
            placeholder="Enter any special conditions, MOQ, packaging, freight assumptions, etc."
        ></textarea>
        </div>

        <div class="flex items-center justify-between gap-2 mt-2">
        <p id="supplier-total-preview" class="text-[11px] text-slate-500">
            No active request.
        </p>
        <button
            id="supplier-submit-btn"
            class="rounded-xl border border-accent bg-accent/5 px-3 py-1.5 text-[11px] text-accent font-medium hover:bg-accent/10 transition"
        >
            Submit quote to buyer (demo)
        </button>
        </div>
    </section>

    <!-- Supplier: how the buyer will see this -->
    <section class="rounded-2xl border bg-white p-4 md:p-5 text-xs shadow-sm">
        <div class="flex items-center justify-between gap-3 mb-3">
        <div>
            <h3 class="text-sm font-semibold text-slate-900">
            How the buyer will see this
            </h3>
            <p class="mt-1 text-xs text-slate-500">
            A concise card with your total value, key terms and ranking against other suppliers.
            </p>
        </div>
        </div>

        <div id="supplier-preview-empty" class="text-[11px] text-slate-500">
        No active request yet. Once the buyer generates a request and you quote, you can preview your card here.
        </div>

        <div
        id="supplier-preview-card"
        class="hidden rounded-xl border border-accent/60 bg-accent/10 px-3 py-3 text-xs shadow-sm"
        >
        <div class="flex items-center justify-between gap-3">
            <div>
            <p id="preview-supplier-name" class="font-medium text-slate-900"></p>
            <p id="preview-request-ref" class="mt-0.5 text-[11px] text-slate-600"></p>
            <p id="preview-terms" class="mt-0.5 text-[11px] text-slate-500"></p>
            </div>
            <div class="text-right text-[11px]">
            <p id="preview-total" class="text-accent font-semibold"></p>
            <p class="text-slate-500">Est. total value</p>
            </div>
        </div>
        <p id="preview-notes" class="mt-2 text-[11px] text-slate-700"></p>
        </div>
    </section>

    <!-- Supplier: tips -->
    <section class="rounded-2xl border bg-white p-4 md:p-5 text-xs shadow-sm">
        <p class="text-[11px] uppercase tracking-wide text-slate-500 mb-1">
        Tips for better ranking
        </p>
        <ul class="space-y-1 text-slate-700">
        <li>‚Ä¢ Make lead time and validity realistic but competitive.</li>
        <li>‚Ä¢ Match the buyer‚Äôs payment terms where possible (e.g. Net 30).</li>
        <li>‚Ä¢ Use notes to clarify what‚Äôs included: freight, packaging, documentation.</li>
        <li>‚Ä¢ In a real deployment, Crontal also considers your historical quality and on-time delivery.</li>
        </ul>
    </section>
    </main>

  </div>

  <!-- PDF PREVIEW MODAL -->
  <div
    id="pdf-modal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60"
  >
    <div class="max-w-2xl w-[90%] bg-white border border-slate-200 rounded-2xl shadow-2xl shadow-slate-400/40 p-4 md:p-5 flex flex-col max-h-[80vh]">
      <div class="flex items-center justify-between gap-3 mb-2">
        <div>
          <h2 class="text-sm font-semibold text-slate-900">RFP PDF preview</h2>
          <p class="text-[11px] text-slate-500">
            This is the content that will be exported to PDF with signature lines.
          </p>
        </div>
        <button
          id="pdf-modal-close"
          class="text-[11px] text-slate-500 hover:text-slate-900 px-2 py-1 rounded-lg border border-transparent hover:border-slate-300"
        >
          Close
        </button>
      </div>
      <div class="flex-1 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-[11px] text-slate-800">
        <pre id="pdf-preview-text" class="whitespace-pre-wrap font-mono text-[11px]"></pre>
      </div>
      <div class="mt-3 flex items-center justify-between gap-2">
        <p class="text-[11px] text-slate-500">
          Click ‚ÄúDownload PDF‚Äù to save a copy with signature areas.
        </p>
        <button
          id="pdf-download-btn"
          class="rounded-xl border border-accent bg-accent/5 px-3 py-1.5 text-[11px] text-accent font-medium hover:bg-accent/10 transition"
        >
          Download PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    const PARSE_URL   = "http://localhost:4000/api/buyer/parse-request";
    const CLARIFY_URL = "http://localhost:4000/api/buyer/clarify";
    const UPLOAD_SPECS_URL = "http://localhost:4000/api/buyer/upload-specs";
    const NEGOTIATE_URL    = "http://localhost:4000/api/buyer/negotiate"; // üëà NEW
    const { jsPDF }   = window.jspdf || {};

    const RFQ_STORAGE_PREFIX = "crontal-rfq-";  // üëà NEW
    const QUOTES_STORAGE_PREFIX = "crontal-quotes-";   // üëà NEW

    let currentRequest      = null;
    let supplierQuotes      = [];
    let supplierUnitPrices  = [];
    let clarifyMessages     = [];
    let lastRfpDraft        = "";
    let lastRfpQuote        = null;
    let supplierPriority    = "pricing"; // "pricing" | "delivery" | "payment"
    let isThinking         = false;  // üëà NEW ‚Äì controls the loading bubble in chat


    const $ = (id) => document.getElementById(id);

    // -------------------------
// DOM element references
// -------------------------
    const chatWindow        = $("chat-window");
    const chatInput         = $("chat-input");
    const sendBtn           = $("chat-send-btn");
    const fileUploadInput  = $("file-upload-input");
    const fileUploadBtn    = $("file-upload-btn");
    const fileUploadStatus = $("file-upload-status");

    const projectNameInput    = $("project-name-input");
    const projectClientInput  = $("project-client-input");
    const projectPackageInput = $("project-package-input");
    const projectRevisionInput= $("project-revision-input");
    const projectStageInput   = $("project-stage-input");

    // --- View toggle ---
    const buyerView    = $("buyer-view");
    const supplierView = $("supplier-view");
    $("toggle-buyer").addEventListener("click", () => {
      buyerView.classList.remove("hidden");
      supplierView.classList.add("hidden");
      $("toggle-buyer").classList.add("bg-accent/10","border","border-accent","text-accent","font-medium");
      $("toggle-supplier").classList.remove("bg-accent/10","border","border-accent","text-accent","font-medium");
    });
    $("toggle-supplier").addEventListener("click", () => {
      supplierView.classList.remove("hidden");
      buyerView.classList.add("hidden");
      $("toggle-supplier").classList.add("bg-accent/10","border","border-accent","text-accent","font-medium");
      $("toggle-buyer").classList.remove("bg-accent/10","border","border-accent","text-accent","font-medium");
    });

    // --- Helper: infer shape ---
    function inferShape(li) {
      const s = (
        (li.product_category || "") + " " +
        (li.product_type || "") + " " +
        (li.raw_description || "")
      ).toLowerCase();
      if (s.includes("square") || s.includes("box")) return "square tube";
      if (s.includes("rectangular")) return "rectangular tube";
      if (s.includes("pipe")) return "pipe";
      if (s.includes("tube") || s.includes("tubing")) return "tube";
      return li.product_category || "";
    }


    function inferCommodity(li) {
        const text = (
            (li.product_category || "") + " " +
            (li.product_type || "") + " " +
            (li.raw_description || "")
        ).toLowerCase();

        if (text.includes("valve")) return "Valve";
        if (
            text.includes("elbow") ||
            text.includes("tee") ||
            text.includes("flange") ||
            text.includes("reducer") ||
            text.includes("fitting")
        ) return "Fitting";
        if (text.includes("pipe") || text.includes("piping")) return "Pipe";
        if (
            text.includes("beam") ||
            text.includes("channel") ||
            text.includes("angle") ||
            text.includes("column") ||
            text.includes("struct")
        ) return "Structural steel";
        if (text.includes("plate") || text.includes("sheet")) return "Plate";
        if (
            text.includes("instrument") ||
            text.includes("gauge") ||
            text.includes("flow meter") ||
            text.includes("transmitter")
        ) return "Instrument";
        return li.product_category || "Other";
        }

        function inferDiscipline(commodity, li) {
        const text = (
            (li.product_category || "") + " " +
            (li.product_type || "") + " " +
            (li.raw_description || "")
        ).toLowerCase();

        if (["Pipe", "Fitting", "Valve"].includes(commodity)) return "Piping";
        if (commodity === "Structural steel") return "Civil/Structural";
        if (commodity === "Instrument") return "Instrumentation";

        if (text.includes("pump") || text.includes("compressor")) return "Mechanical";
        if (text.includes("cable") || text.includes("switchgear")) return "Electrical";

        return "Mechanical";
    }


    // --- Map backend RFQ into currentRequest ---
    function mapBackendToCurrentRequest(data, rawText) {
      const rfqId     = data.rfq_id || ("RFQ-" + Date.now());
      const lineItems = Array.isArray(data.line_items) ? data.line_items : [];
      const items = lineItems.map((li, idx) => {
      const size = li.size || {};
      const od   = size.outer_diameter || {};
      const wt   = size.wall_thickness || {};
      const len  = size.length || {};

      const commodity  = inferCommodity(li);
      const discipline = inferDiscipline(commodity, li);

      return {
        line: idx + 1,
        description: li.product_type || li.raw_description || "Line " + (idx + 1),
        discipline,
        commodity,
        shape: inferShape(li),
        grade: li.material_grade || "",
        quantity: li.quantity ?? null,
        uom: li.unit || "",
        wt: wt.value != null ? `${wt.value}${wt.unit ? " " + wt.unit : ""}` : "",
        diameter: od.value != null ? `${od.value}${od.unit ? " " + od.unit : ""}` : "",
        length: len.value != null ? `${len.value}${len.unit ? " " + len.unit : ""}` : ""
    };
    });


      let otherReq = "";
      lineItems.forEach(li => {
        if (Array.isArray(li.other_requirements) && li.other_requirements.length) {
          otherReq += (otherReq ? "; " : "") + li.other_requirements.join("; ");
        }
      });

      const first = lineItems[0] || {};
      const commercial = {
        destination: first.delivery_location || "",
        incoterm:    first.incoterm || "",
        paymentTerm: first.payment_terms || "",
        otherRequirements: otherReq
      };
      return {
        id: rfqId,
        raw: rawText,
        items,
        commercial,
        supplierLink: data.supplier_link || ""
      };
    }

    function syncProjectFieldsFromRequest() {
        if (!currentRequest || !currentRequest.project) return;

        const p = currentRequest.project;
        if (projectNameInput)    projectNameInput.value    = p.projectName    || "";
        if (projectClientInput)  projectClientInput.value  = p.clientName     || "";
        if (projectPackageInput) projectPackageInput.value = p.packageId      || "";
        if (projectRevisionInput)projectRevisionInput.value= p.revision       || "";
        if (projectStageInput)   projectStageInput.value   = p.stage          || "";
}

    // --- Structured request render ---
    function renderBuyerRequest() {
      const empty   = $("buyer-request-empty");
      const block   = $("buyer-request-block");
      const idLabel = $("request-id-label");
      if (!currentRequest) {
        empty.classList.remove("hidden");
        block.classList.add("hidden");
        idLabel.textContent = "None yet";
        return;
      }
      empty.classList.add("hidden");
      block.classList.remove("hidden");
      idLabel.textContent = currentRequest.id;
      // NEW: whenever we render the request, sync project fields if present
      syncProjectFieldsFromRequest();

      const tbody = $("buyer-items-body");
      tbody.innerHTML = "";
      currentRequest.items.forEach((item, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="px-3 py-2">${item.line}</td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input w-full rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="description"
                value="${item.description || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input w-full rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="discipline"
                value="${item.discipline || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input w-full rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="commodity"
                value="${item.commodity || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input w-full rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="shape"
                value="${item.shape || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input-short rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="grade"
                value="${item.grade || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input-short rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="quantity"
                value="${item.quantity ?? ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input-short rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="uom"
                value="${item.uom || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input-short rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="wt"
                value="${item.wt || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input-short rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="diameter"
                value="${item.diameter || ""}"
            />
            </td>
            <td class="px-3 py-2">
            <input
                class="buyer-item-input rfq-input-short rounded border border-slate-300 px-2 py-1"
                data-index="${idx}" data-field="length"
                value="${item.length || ""}"
            />
            </td>
        `;
        tbody.appendChild(tr);
        });

      $("buyer-destination").textContent =
        currentRequest.commercial.destination || "‚Äì";
      $("buyer-incoterm").textContent =
        currentRequest.commercial.incoterm || "‚Äì";
      $("buyer-payment").textContent =
        currentRequest.commercial.paymentTerm || "‚Äì";
      const otherEl = $("buyer-other-req");
      if (otherEl) otherEl.value = currentRequest.commercial.otherRequirements || "";

      renderShareLink();
      renderSupplierRequest();
      renderSupplierPreview();
    }

    function renderShareLink() {
      const block  = $("share-link-block");
      const label  = $("share-link-label");
      const input  = $("share-link-input");
      if (!block || !label || !input) return;

      if (!currentRequest) {
        block.classList.add("hidden");
        label.textContent =
          "Start a conversation to get a structured request and link you can send to suppliers.";
        input.value = "";
        return;
      }

      block.classList.remove("hidden");
      label.textContent =
        "Share this link with suppliers so they can view and submit quotes against this request.";

      currentRequest.id = currentRequest.id || currentRequest.rfq_id || ("RFQ-" + Date.now());
      const rfqId = currentRequest.id;

      // Build a link to the supplier portal hosted on the same server
      const url = new URL(window.location.href);
      url.pathname = url.pathname.replace(/buyer-demo\.html.*$/, "supplier-demo.html");
      url.search = `?rfq_id=${encodeURIComponent(rfqId)}`;

      input.value = url.toString();
}


    // --- Supplier request render ---
    function renderSupplierRequest() {
      const empty     = $("supplier-request-empty");
      const block     = $("supplier-request-block");
      const idLabel   = $("supplier-request-id");
      const summaryEl = $("supplier-request-summary");
      const tbody     = $("supplier-items-body");
      if (!empty || !block || !idLabel || !tbody) return;

      if (!currentRequest) {
        empty.classList.remove("hidden");
        block.classList.add("hidden");
        idLabel.textContent = "None yet";
        return;
      }
      empty.classList.add("hidden");
      block.classList.remove("hidden");
      idLabel.textContent = currentRequest.id;

      const item = currentRequest.items[0] || {};
      const c    = currentRequest.commercial;
      summaryEl.textContent =
        (item.quantity ? item.quantity + " " + (item.uom || "") : "Quantity not detected") +
        " of " +
        (item.description || "stainless product") +
        (item.grade ? " ¬∑ Grade " + item.grade : "") +
        (c.destination ? " ¬∑ Deliver to " + c.destination : "") +
        (c.incoterm ? " ¬∑ " + c.incoterm : "") +
        (c.paymentTerm ? " ¬∑ " + c.paymentTerm : "");

      tbody.innerHTML = "";
      supplierUnitPrices = [];
      currentRequest.items.forEach((it, idx) => {
        supplierUnitPrices.push(NaN);

        const specParts = [];
        if (it.diameter) specParts.push(it.diameter);
        if (it.wt)       specParts.push(it.wt + " wall");
        if (it.length)   specParts.push(it.length);
        const specText = specParts.join(" ¬∑ ") || "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${it.line}</td>
          <td class="px-3 py-2">${it.description || "-"}</td>
          <td class="px-3 py-2">${it.grade || "-"}</td>
          <td class="px-3 py-2">${specText}</td>
          <td class="px-3 py-2">${it.quantity ?? "-"}</td>
          <td class="px-3 py-2">${it.uom || "-"}</td>
          <td class="px-3 py-2">
            <input
              type="number"
              step="0.01"
              class="supplier-price-input w-24 rounded-lg border border-slate-300 px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-accent"
              placeholder="0.00"
              data-index="${idx}"
            />
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateSupplierTotalPreview();
    }

    // --- Chat render & clarifier ---
    function renderChat() {
      const win = $("chat-window");

      // Existing messages
      let html = clarifyMessages.map(m => {
        const isUser = m.role === "user";
        return `
          <div class="flex ${isUser ? "justify-end" : "justify-start"}">
            <div class="max-w-[85%] rounded-xl px-3 py-2 text-[11px] break-words ${
              isUser
                ? "bg-accent/10 text-slate-900 border border-accent/40"
                : "bg-white border border-slate-200 text-slate-800"
            }">
              ${m.content.replace(/\n/g,"<br/>")}
            </div>
          </div>`;
      }).join("");

      // üëá NEW: animated "Crontal is thinking‚Ä¶" bubble
      if (isThinking) {
        html += `
          <div class="flex justify-start">
            <div class="mt-1 inline-flex items-center gap-1 max-w-[85%] rounded-xl px-3 py-2 text-[11px] bg-white border border-slate-200 text-slate-500">
              <span>Crontal is thinking</span>
              <span class="loading-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </span>
            </div>
          </div>`;
      }

      win.innerHTML = html;
      win.scrollTop = win.scrollHeight;
    }

    async function negotiateForQuote(index, type) {
        if (!currentRequest || !supplierQuotes[index]) return;

        const q = supplierQuotes[index];
        const outputDiv = $("quote-neg-output-" + index);
        if (!outputDiv) return;

        const goalByType = {
            price:   "improve total price while keeping scope unchanged",
            delivery:"improve delivery lead time while keeping price and scope reasonable",
            payment: "improve payment terms in the buyer's favor without losing the quote"
        };
        const goal = goalByType[type] || "negotiate this quote in the buyer's favor";
        const goalLabel =
            type === "price"
            ? "pricing"
            : type === "delivery"
            ? "delivery"
            : type === "payment"
            ? "payment terms"
            : "terms";

        outputDiv.textContent =
            "Crontal is analyzing this quote and preparing negotiation advice...";

        try {
            const res = await fetch(NEGOTIATE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                rfq: currentRequest,
                quote: q,
                goal
            })
            });

            if (!res.ok) {
            const txt = await res.text();
            console.error("Negotiation API error:", txt);
            outputDiv.textContent =
                "Unable to get negotiation advice right now. Please try again later.";
            // also log in chat
            clarifyMessages.push({
                role: "assistant",
                content:
                `I tried to prepare negotiation advice for ${q.supplierName || "this supplier"} but the negotiation API returned an error. Please try again later.`
            });
            renderChat();
            return;
            }

            const data = await res.json();
            const advice =
            data.advice ||
            "No specific advice returned. Please try again with a different negotiation goal.";

            // Show advice under the supplier card
            outputDiv.textContent = advice;

            // Also surface it in the chat window so it feels like Crontal replying
            clarifyMessages.push({
            role: "assistant",
            content:
                `Here is my negotiation advice for ${q.supplierName || "this supplier"} focusing on ${goalLabel}:\n\n` +
                advice
            });
            renderChat();

            // Build a ready-to-send email draft using this advice (for the "Open email draft" button)
            const rfqId   = currentRequest.id || currentRequest.rfq_id || "RFQ";
            const contact = q.supplierName || "Supplier";

            let subject;
            if (type === "price") {
            subject = `Follow-up on RFQ ${rfqId} ‚Äì pricing discussion`;
            } else if (type === "delivery") {
            subject = `Follow-up on RFQ ${rfqId} ‚Äì delivery timeline`;
            } else if (type === "payment") {
            subject = `Follow-up on RFQ ${rfqId} ‚Äì payment terms`;
            } else {
            subject = `Follow-up on RFQ ${rfqId}`;
            }

            const body =
            `Dear ${contact},\n\n` +
            advice +
            `\n\nBest regards,\n[Your name]\n[Your company]`;

            q._emailDraft = { subject, body };  // store for openEmailForQuote
        } catch (err) {
            console.error("Negotiation fetch error:", err);
            outputDiv.textContent =
            "Network error while getting negotiation advice. Please try again.";
            clarifyMessages.push({
            role: "assistant",
            content:
                `There was a network error while trying to prepare negotiation advice for ${q.supplierName || "this supplier"}. Please try again.`
            });
            renderChat();
        }
        }



    async function initFromUrl() {
        const params    = new URLSearchParams(window.location.search);
        const viewParam = params.get("view");
        const rfqId     = params.get("rfq_id");

        // If link is for supplier, default to supplier view
        if (viewParam === "supplier") {
            buyerView.classList.add("hidden");
            supplierView.classList.remove("hidden");

            $("toggle-supplier").classList.add(
            "bg-accent/10","border","border-accent","text-accent","font-medium"
            );
            $("toggle-buyer").classList.remove(
            "bg-accent/10","border","border-accent","text-accent","font-medium"
            );
        }

        if (!rfqId) return;

        const storageKey = RFQ_STORAGE_PREFIX + rfqId;
        try {
            const stored = localStorage.getItem(storageKey);
            if (!stored) {
            console.warn("No RFQ found in localStorage for id:", rfqId);
            return;
            }

            const parsed = JSON.parse(stored);

            // Hydrate the in-memory request and render
            currentRequest = parsed;
            renderBuyerRequest(); // this also refreshes supplier request + preview
            loadQuotesFromBackend();
        } catch (err) {
            console.error("Failed to load RFQ from localStorage:", err);
        }
}


    async function callClarifyAPI(userMessage) {
        if (!currentRequest) return;
        const body = { rfq: currentRequest, history: clarifyMessages, user_message: userMessage || "" };
        const res = await fetch(CLARIFY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            console.error("Clarifier error:", res.status, await res.text());
            return;
        }
        const data = await res.json();
        if (data.assistant_message) {
            clarifyMessages.push({ role: "assistant", content: data.assistant_message });
            renderChat();
        }
}

    function setFileUploadStatus(msg, isError = false) {
        if (!fileUploadStatus) return;
        fileUploadStatus.textContent = msg || "";
        fileUploadStatus.className =
            "text-[11px] " + (isError ? "text-red-500" : "text-slate-500");
}

    async function uploadSpecsAndParse() {
        if (!fileUploadInput || !fileUploadInput.files || !fileUploadInput.files.length) {
            setFileUploadStatus("Please select at least one file first.", true);
            return;
        }

        const formData = new FormData();
        Array.from(fileUploadInput.files).forEach((file) => {
            formData.append("files", file);
        });

        fileUploadBtn.disabled = true;
        isThinking = true;       // reuse your chat loader
        renderChat();
        setFileUploadStatus("Uploading and parsing files...");

        try {
            const res = await fetch(UPLOAD_SPECS_URL, {
            method: "POST",
            body: formData
            });

            if (!res.ok) {
            let message = "Parsing failed.";
            try {
                const errJson = await res.json();
                if (errJson && errJson.error) {
                message = errJson.error;
                }
            } catch (e) {
                const text = await res.text().catch(() => "");
                console.error("upload-specs error (non-JSON):", text || e);
            }

            console.error("upload-specs error:", message);
            setFileUploadStatus(message, true);

            // Optional: drop a message into the chat so the buyer sees it there too
            clarifyMessages.push({
                role: "assistant",
                content:
                "I tried to parse the uploaded files but ran into a problem: " +
                message +
                " If this is a scanned PDF, I may not be able to read it yet."
            });
            renderChat();
            return;
            }


            const data = await res.json();

            // Use your existing mapper to normalize into currentRequest
            const rawText = data.original_text || "";
            currentRequest = mapBackendToCurrentRequest(data, rawText);

            // Reset any existing quotes for this new RFQ
            supplierQuotes     = [];
            supplierUnitPrices = [];
            const qCount = $("quotes-count");
            const qEmpty = $("quotes-empty");
            const qList  = $("quotes-list");
            if (qCount) qCount.textContent = "0";
            if (qEmpty) qEmpty.classList.remove("hidden");
            if (qList) { qList.classList.add("hidden"); qList.innerHTML = ""; }

            // Update UI
            renderBuyerRequest();
            if (!currentRequest.project) {
            currentRequest.project = {
                projectName:  "",
                clientName:   "",
                packageId:    "",
                revision:     "Rev 0",
                stage:        ""
                };
            }
            syncProjectFieldsFromRequest();

            setFileUploadStatus(
            `Parsed ${currentRequest.items?.length || 0} line item(s) from files.`
            );

            // Optional: add a clarifier assistant message to chat
            clarifyMessages.push({
            role: "assistant",
            content:
                `I've parsed your uploaded files into ${currentRequest.items?.length || 0} structured line item(s). ` +
                `You can refine specs here or tell me about destination, delivery dates, and payment terms.`
            });
            renderChat();
        } catch (err) {
            console.error("upload-specs error:", err);
            setFileUploadStatus("Parsing failed. Network or server error.", true);
        } finally {
            fileUploadBtn.disabled = false;
            isThinking = false;
            renderChat();
        }
}

    async function parseInitial(text) {
      const res = await fetch(PARSE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, project_name: null })
      });
      if (!res.ok) {
        console.error("Parse error:", res.status, await res.text());
        return false;
      }
      const data = await res.json();
      currentRequest = mapBackendToCurrentRequest(data, text);
      renderBuyerRequest();
      if (!currentRequest.project) {
        currentRequest.project = {
            projectName:  "",
            clientName:   "",
            packageId:    "",
            revision:     "Rev 0",
            stage:        ""
        };
        }
syncProjectFieldsFromRequest();

      return true;
    }

    async function reparseWithAdditionalText(extraText) {
      if (!currentRequest) return;
      const combinedText =
        (currentRequest.raw || "") +
        "\n\nAdditional clarification from buyer:\n" +
        extraText;
      const res = await fetch(PARSE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: combinedText, project_name: null })
      });
      if (!res.ok) {
        console.error("Re-parse error:", res.status, await res.text());
        return;
      }
      const data = await res.json();
      currentRequest = mapBackendToCurrentRequest(data, combinedText);
      supplierQuotes     = [];
      supplierUnitPrices = [];
      const qCount = $("quotes-count");
      const qEmpty = $("quotes-empty");
      const qList  = $("quotes-list");
      if (qCount) qCount.textContent = "0";
      if (qEmpty) qEmpty.classList.remove("hidden");
      if (qList) { qList.classList.add("hidden"); qList.innerHTML = ""; }
      renderBuyerRequest();
    }

    function computeSupplierTotal() {
      if (!currentRequest) return { hasPrice:false, total:0 };
      let total = 0; let hasPrice = false;
      currentRequest.items.forEach((item, idx) => {
        const price = supplierUnitPrices[idx];
        if (!Number.isFinite(price)) return;
        hasPrice = true;
        const qty = item.quantity ?? 0;
        total += (qty || 1) * price;
      });
      return { hasPrice, total };
    }

    function updateSupplierTotalPreview() {
      const label = $("supplier-total-preview");
      if (!label) return;
      if (!currentRequest) {
        label.textContent = "No active request.";
        return;
      }
      const { hasPrice, total } = computeSupplierTotal();
      const currency = $("supplier-currency-input")?.value || "USD";
      if (!hasPrice) {
        label.textContent = "Fill in unit prices to see the estimated total value.";
        return;
      }
      label.textContent =
        "Estimated total: " + currency + " " +
        total.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
    }

    function renderSupplierPreview() {
      const empty = $("supplier-preview-empty");
      const card  = $("supplier-preview-card");
      if (!empty || !card) return;
      const { hasPrice, total } = computeSupplierTotal();
      if (!currentRequest || !hasPrice) {
        card.classList.add("hidden");
        empty.textContent = currentRequest
          ? "Start typing unit prices and meta info to see a live preview of your quote card."
          : "No active request yet.";
        return;
      }
      const supplierName = $("supplier-name-input")?.value || "Your company";
      const currency     = $("supplier-currency-input")?.value || "USD";
      const leadTime     = $("supplier-leadtime-input")?.value || "‚Äì";
      const payment      =
        $("supplier-payment-input")?.value ||
        currentRequest.commercial.paymentTerm ||
        "‚Äì";
      const validity     = $("supplier-validity-input")?.value || "‚Äì";
      const notes        =
        $("supplier-notes-input")?.value || "No special conditions provided.";
      empty.textContent  = "";
      card.classList.remove("hidden");
      $("preview-supplier-name").textContent = supplierName;
      $("preview-request-ref").textContent   =
        "Quote for " + (currentRequest.id || "RFQ") +
        " ¬∑ " + (currentRequest.items[0]?.description || "stainless request");
      $("preview-terms").textContent        =
        "Lead time: " + leadTime +
        " days ¬∑ Payment: " + payment +
        " ¬∑ Validity: " + validity + " days";
      $("preview-total").textContent        =
        currency + " " + total.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      $("preview-notes").textContent        = notes;
    }

    // --- Priority ranking helpers ---
    function parseDaysFromText(text) {
      if (!text) return NaN;
      const m1 = text.match(/(\d+)\s*day/i);
      if (m1) return Number(m1[1]);
      const m2 = text.match(/net\s*(\d+)/i);
      if (m2) return Number(m2[1]);
      return NaN;
    }

    function getBestSupplierIndex() {
      if (!supplierQuotes.length) return -1;

      if (supplierPriority === "pricing") {
        let bestIdx = -1;
        let bestTotal = Infinity;
        supplierQuotes.forEach((q, idx) => {
          if (typeof q.total === "number" && !isNaN(q.total) && q.total < bestTotal) {
            bestTotal = q.total;
            bestIdx   = idx;
          }
        });
        return bestIdx;
      }

      if (supplierPriority === "delivery") {
        let bestIdx = -1;
        let bestLead = Infinity;
        supplierQuotes.forEach((q, idx) => {
          const d = Number(q.leadTime);
          const lead = isNaN(d) ? Infinity : d;
          if (lead < bestLead) {
            bestLead = lead;
            bestIdx  = idx;
          }
        });
        if (bestIdx !== -1 && bestLead !== Infinity) return bestIdx;
        supplierPriority = "pricing";
        return getBestSupplierIndex();
      }

      if (supplierPriority === "payment") {
        let bestIdx = -1;
        let bestDays = -Infinity;
        supplierQuotes.forEach((q, idx) => {
          const days = parseDaysFromText(q.payment);
          if (!isNaN(days) && days > bestDays) {
            bestDays = days;
            bestIdx  = idx;
          }
        });
        if (bestIdx !== -1 && bestDays !== -Infinity) return bestIdx;
        supplierPriority = "pricing";
        return getBestSupplierIndex();
      }

      return -1;
    }

    function renderQuotes() {
        const countEl = $("quotes-count");
        const emptyEl = $("quotes-empty");
        const listEl  = $("quotes-list");
        if (!countEl || !emptyEl || !listEl) return;

        countEl.textContent = supplierQuotes.length.toString();
        if (!supplierQuotes.length) {
            emptyEl.classList.remove("hidden");
            listEl.classList.add("hidden");
            listEl.innerHTML = "";
            return;
        }

        emptyEl.classList.add("hidden");
        listEl.classList.remove("hidden");
        listEl.innerHTML = "";

        const bestIdx = getBestSupplierIndex();
        const priorityLabel =
            supplierPriority === "pricing"
            ? "pricing"
            : supplierPriority === "delivery"
            ? "delivery timeline"
            : "payment terms";

        supplierQuotes.forEach((q, idx) => {
            const isBest = idx === bestIdx;
            const card   = document.createElement("div");
            card.className =
            "rounded-xl px-3 py-2 border text-xs flex flex-col gap-2 " +
            (isBest
                ? "border-accent/70 bg-accent/10"
                : "border-slate-200 bg-white");

            const totalText =
            typeof q.total === "number" && !isNaN(q.total)
                ? `${q.currency || "USD"} ${q.total.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`
                : "N/A";

            const lineCount = q.items?.length || 1;

            // Build line details list for the expandable section
            const lineDetailsHtml = (q.items || [])
            .map((li, itemIdx) => {
                const base = (currentRequest.items || [])[itemIdx] || {};
                const desc = base.description || `Line ${li.line || itemIdx + 1}`;
                const qty  = base.quantity ?? "";
                const uom  = base.uom || "";
                const unitPriceText =
                typeof li.unitPrice === "number"
                    ? `${q.currency || "USD"} ${li.unitPrice.toFixed(2)}`
                    : "‚Äì";
                const lineTotalText =
                typeof li.lineTotal === "number"
                    ? `${q.currency || "USD"} ${li.lineTotal.toFixed(2)}`
                    : "‚Äì";

                return `<li>Line ${li.line ?? itemIdx + 1}: ${desc} ‚Äì ${qty} ${uom} ‚Äì Unit: ${unitPriceText}, Total: ${lineTotalText}</li>`;
            })
            .join("");

            card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
                <div>
                <p class="font-medium text-slate-900">
                    ${q.supplierName || "Unnamed supplier"}
                </p>
                <p class="mt-0.5 text-[11px] text-slate-600">
                    Total: ${totalText}
                </p>
                <p class="mt-0.5 text-[11px] text-slate-500">
                    Lead time: ${q.leadTime || "‚Äì"} days ¬∑ Payment: ${q.payment || "‚Äì"} ¬∑ Validity: ${q.validity || "‚Äì"} days
                </p>
                <p class="mt-0.5 text-[11px] text-slate-500 line-clamp-2">
                    ${q.notes || "No special conditions."}
                </p>
                </div>
                <div class="text-right text-[11px]">
                ${
                    isBest
                    ? `<span class="inline-flex items-center rounded-full bg-accent/10 border border-accent px-2 py-0.5 text-accent font-medium mb-1">Best offer (${priorityLabel})</span>`
                    : ""
                }
                <p class="text-slate-500">
                    Lines: ${lineCount}
                </p>
                </div>
            </div>

            <div class="mt-2 flex flex-wrap items-center gap-2 text-[11px]">
                <button
                class="quote-toggle-details rounded-full border border-slate-300 px-2 py-1 hover:border-accent/60 hover:text-accent transition"
                data-index="${idx}"
                >
                View details
                </button>
                <span class="text-slate-400 text-[10px] uppercase tracking-wide">
                Negotiate with AI:
                </span>
                <button
                class="quote-neg-btn rounded-full border border-accent/50 bg-accent/5 px-2 py-1 text-[11px] text-accent hover:bg-accent/10 transition"
                data-index="${idx}"
                data-type="price"
                >
                Better pricing
                </button>
                <button
                class="quote-neg-btn rounded-full border border-accent/50 bg-accent/5 px-2 py-1 text-[11px] text-accent hover:bg-accent/10 transition"
                data-index="${idx}"
                data-type="delivery"
                >
                Faster delivery
                </button>
                <button
                class="quote-neg-btn rounded-full border border-accent/50 bg-accent/5 px-2 py-1 text-[11px] text-accent hover:bg-accent/10 transition"
                data-index="${idx}"
                data-type="payment"
                >
                Better payment
                </button>
            </div>

            <div
  id="quote-details-${idx}"
  class="mt-2 hidden border-t border-slate-200 pt-2 text-[11px] text-slate-600"
>
  <p>
    <span class="font-semibold">Contact:</span>
    ${q.email || "‚Äî"}${q.phone ? " ¬∑ " + q.phone : ""}
  </p>
  ${
    lineDetailsHtml
      ? `<p class="mt-1"><span class="font-semibold">Line details:</span></p>
         <ul class="mt-0.5 ml-4 list-disc">
           ${lineDetailsHtml}
         </ul>`
      : ""
  }
        <div
            id="quote-neg-output-${idx}"
            class="mt-2 text-[11px] text-slate-700"
        ></div>

        <div class="mt-3 flex flex-wrap items-center gap-2">
            <button
            class="quote-email-btn rounded-full border border-accent/60 bg-accent/5 px-2.5 py-1 text-[11px] text-accent hover:bg-accent/10 transition"
            data-index="${idx}"
            >
            Open email draft to supplier
            </button>
            <span
            id="quote-email-hint-${idx}"
            class="text-[10px] text-slate-400 hidden"
            >
            Email draft opened in your default email client.
            </span>
        </div>
        </div>
            `;

            listEl.appendChild(card);
        });
        }

        // Delegated click handling for supplier response cards
        const quotesListEl = $("quotes-list");
            if (quotesListEl) {
            quotesListEl.addEventListener("click", (e) => {
                const detailsBtn = e.target.closest(".quote-toggle-details");
                if (detailsBtn) {
                const idx = detailsBtn.dataset.index;
                const detailsEl = $("quote-details-" + idx);
                if (detailsEl) {
                    const isHidden = detailsEl.classList.contains("hidden");
                    detailsEl.classList.toggle("hidden");
                    detailsBtn.textContent = isHidden ? "Hide details" : "View details";
                }
                return;
                }

                const negBtn = e.target.closest(".quote-neg-btn");
                if (negBtn) {
                const idx  = parseInt(negBtn.dataset.index, 10);
                const type = negBtn.dataset.type;
                negotiateForQuote(idx, type);
                return;
                }

                const emailBtn = e.target.closest(".quote-email-btn");
                if (emailBtn) {
                const idx = parseInt(emailBtn.dataset.index, 10);
                openEmailForQuote(idx);
                return;
                }
            });
            }



    // ----------------------------------------------------------
    // BUYER: Load quotes for this RFQ from localStorage
    // ----------------------------------------------------------
    
    async function loadQuotesFromBackend() {
      if (!currentRequest) return;
      const rfqId = currentRequest.id || currentRequest.rfq_id;
      if (!rfqId) return;

      try {
        const res = await fetch(`/api/rfqs/${encodeURIComponent(rfqId)}/quotes`);
        if (!res.ok) {
          console.error("Failed to load quotes:", await res.text());
          return;
        }
        const data = await res.json();
        supplierQuotes = data.quotes || [];
        renderQuotes();
      } catch (err) {
        console.error("Error loading quotes:", err);
      }
    }


    // Save quotes for this RFQ to localStorage (so other tabs can pick them up)
    function saveQuotesToStorage() {
        if (!currentRequest) return;
        const rfqId = currentRequest.id || currentRequest.rfq_id;
        if (!rfqId) return;
        const key = QUOTES_STORAGE_PREFIX + rfqId;
        try {
            localStorage.setItem(key, JSON.stringify(supplierQuotes));
        } catch (err) {
            console.error("Failed to store quotes in localStorage:", err);
        }
    }

    function openEmailForQuote(index) {
        if (!supplierQuotes[index]) return;

        const q = supplierQuotes[index];
        const email = (q.email || "").trim();
        const hint  = $("quote-email-hint-" + index);

        if (!email) {
            alert(
            "This supplier did not provide an email address in the quote. Please add one to the quote or copy the draft manually."
            );
            return;
               }

        const draft = q._emailDraft || {};
        const subject =
            draft.subject ||
            `Follow-up on RFQ ${currentRequest?.id || currentRequest?.rfq_id || "RFQ"}`;

        // Use a single template literal for the fallback email body to avoid stray quote/backtick errors
        const body =
            draft.body ||
            `Dear ${q.supplierName || "Supplier"},
+
Thank you for your quotation. I'd like to discuss some adjustments to your offer for RFQ ${currentRequest?.id || currentRequest?.rfq_id || "our recent request"}.
+
Best regards,
[Your name]
[Your company]`;

        const mailto =
            "mailto:" +
            encodeURIComponent(email) +
            "?subject=" +
            encodeURIComponent(subject) +
            "&body=" +
            encodeURIComponent(body);

        // Open default email client
        window.location.href = mailto;

        if (hint) {
            hint.classList.remove("hidden");
            setTimeout(() => hint.classList.add("hidden"), 4000);
        }
    }


    // ----------------------------------------------------------
    // BUYER: Live-updates when supplier submits quotes in another tab
    // ----------------------------------------------------------
    window.addEventListener("storage", (event) => {
        if (!currentRequest) return;

        const rfqId = currentRequest.id || currentRequest.rfq_id;
        const key = QUOTES_STORAGE_PREFIX + rfqId;

        if (event.key !== key) return; // ignore other keys

        try {
            supplierQuotes = event.newValue ? JSON.parse(event.newValue) : [];
        } catch {
            supplierQuotes = [];
        }

        renderQuotes(); // update supplier responses list
    });


    // ---- Chat seeding ----
    clarifyMessages.push({
      role: "assistant",
      content: "Hi! I‚Äôm Crontal‚Äôs RFQ assistant. Tell me what you‚Äôd like to buy (sizes, grades, quantities, delivery location, payment terms), and I‚Äôll turn it into a structured table on the right that you can edit."
    });
    renderChat();



    $("chat-send-btn").addEventListener("click", async () => {
      const input = $("chat-input");
      const text  = input.value.trim();
      if (!text) return;

      input.value = "";
      clarifyMessages.push({ role: "user", content: text });
      isThinking = true;                          // üëà start thinking
      $("chat-send-btn").disabled = true;         // optional: prevent spam
      $("chat-input").disabled     = true;        // optional: disable input
      renderChat();

      try {
        if (!currentRequest) {
          const ok = await parseInitial(text);    // parsing RFQ
          if (ok) await callClarifyAPI(text);     // clarifier reply
        } else {
          await reparseWithAdditionalText(text);  // re-parse with extra info
          await callClarifyAPI(text);             // clarifier reply
        }
      } finally {
        isThinking = false;                       // üëà done thinking
        $("chat-send-btn").disabled = false;
        $("chat-input").disabled     = false;
        renderChat();                            // re-render to hide loader
      }
    });

    // File upload ‚Üí parse specs into line items
    if (fileUploadBtn) {
    fileUploadBtn.addEventListener("click", (e) => {
        e.preventDefault();
        uploadSpecsAndParse();
    });
    }


    $("chat-input").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        $("chat-send-btn").click();
      }
    });


    // --- Priority toggle UI ---
    const priorityButtons = {
      pricing:  $("priority-pricing"),
      delivery: $("priority-delivery"),
      payment:  $("priority-payment")
    };

    function setPriority(p) {
      supplierPriority = p;
      Object.entries(priorityButtons).forEach(([key, btn]) => {
        if (!btn) return;
        if (key === p) btn.classList.add("priority-active");
        else btn.classList.remove("priority-active");
      });
      renderQuotes();
    }

    priorityButtons.pricing.addEventListener("click",  () => setPriority("pricing"));
    priorityButtons.delivery.addEventListener("click", () => setPriority("delivery"));
    priorityButtons.payment.addEventListener("click",  () => setPriority("payment"));
    setPriority("pricing");

    // --- RFP generation & PDF ---
    
    $("generate-rfp-btn").addEventListener("click", () => {
    const output = $("rfp-output");
    if (!currentRequest) {
        output.value =
        "Please finalize a structured request and select at least one supplier quote before generating the award email.";
        return;
    }
    if (!supplierQuotes.length) {
        output.value =
        "No supplier quotes yet. Once you have at least one quote, Crontal can draft an award email for the top-ranked supplier.";
        return;
    }

    const idx = getBestSupplierIndex();
    if (idx === -1) {
        output.value =
        "Cannot determine the top supplier for the current priority. Please make sure at least one quote has price and terms.";
        return;
    }

    const target = supplierQuotes[idx];
    const items  = currentRequest.items || [];
    const first  = items[0] || {};
    const c      = currentRequest.commercial || {};

    // Build a short scope summary
    const lineSummary =
        items.length === 1
        ? (first.description || "stainless products")
        : `${items.length} line items (including ${first.description || "stainless products"})`;

    const totalText =
        typeof target.total === "number"
        ? `${target.currency || "USD"} ${target.total.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
            })}`
        : "N/A";

    const rfqId    = currentRequest.id || currentRequest.rfq_id || "reference";
    const subject  = `Award ‚Äì RFQ ${rfqId} ‚Äì ${first.description || "stainless steel products"}`;
    const delivery = c.destination || "-";
    const incoterm = c.incoterm || "Incoterm TBD";
    const leadTime = target.leadTime || "‚Äì";
    const payment  = target.payment || c.paymentTerm || "-";
    const validity = target.validity || "‚Äì";

    const awardEmail = `
    Subject: ${subject}

    Dear ${target.supplierName || "Supplier"},

    Thank you for your quotation submitted via Crontal for RFQ ${rfqId}. Based on your pricing and commercial terms, we would like to proceed with your offer as the selected supplier.

    Summary of the award:
    ‚Ä¢ RFQ: ${rfqId}
    ‚Ä¢ Scope: ${lineSummary}
    ‚Ä¢ Estimated total value: ${totalText}
    ‚Ä¢ Delivery: ${delivery} (${incoterm})
    ‚Ä¢ Lead time: ${leadTime} days
    ‚Ä¢ Payment terms: ${payment}
    ‚Ä¢ Quote validity: ${validity} days

    We have attached the formal RFQ / award document in PDF format reflecting these terms. Please review the attached document, confirm acceptance in writing, and let us know if you have any questions or required clarifications.

    Best regards,
    [Your name]
    [Your company]`.trim();

    // Save for PDF generator (optional "Narrative" section)
    lastRfpDraft = awardEmail;
    lastRfpQuote = target;

    // Populate text area
    output.value = awardEmail;

    // Also update the PDF preview text so the modal shows this copy if opened
    $("pdf-preview-text").textContent = awardEmail;

    // Optionally open the preview modal right away
    $("pdf-modal").classList.remove("hidden");
    $("pdf-modal").classList.add("flex");
    });

    $("pdf-modal-close").addEventListener("click", () => {
      $("pdf-modal").classList.add("hidden");
      $("pdf-modal").classList.remove("flex");
    });
    $("pdf-modal").addEventListener("click", (e) => {
      if (e.target.id === "pdf-modal") {
        $("pdf-modal").classList.add("hidden");
        $("pdf-modal").classList.remove("flex");
      }
    });
    $("pdf-download-btn").addEventListener("click", () => {
  if (!jsPDF || !currentRequest || !lastRfpQuote) return;
  const { jsPDF: JsPDF } = window.jspdf || {};
  const doc = new JsPDF({ unit: "pt", format: "a4" });

  const left = 40;
  const maxW = 515;
  let y = 40;

  const rfqId = currentRequest.id || currentRequest.rfq_id || "RFQ";
  const supplier = lastRfpQuote;

  // ---------- HEADER ----------
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Request for Proposal (RFP)", left, y);
  y += 20;

  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  doc.text(`RFQ ID: ${rfqId}`, left, y);
  y += 14;
  doc.text(`Project: ${currentRequest.project_name || "‚Äì"}`, left, y);
  y += 14;
  doc.text(`Buyer: [Your company name here]`, left, y);
  y += 14;
  doc.text(
    `Selected supplier: ${supplier.supplierName || "N/A"}`,
    left,
    y
  );
  y += 20;

  // ---------- COMMERCIAL TERMS ----------
  const c = currentRequest.commercial || {};
  const currency = supplier.currency || "USD";

  doc.setFont("helvetica", "bold");
  doc.text("Commercial terms", left, y);
  y += 14;
  doc.setFont("helvetica", "normal");
  const commercialLines = [
    `Destination: ${c.destination || "‚Äì"}`,
    `Incoterm: ${c.incoterm || "‚Äì"}`,
    `Payment terms: ${supplier.payment || c.paymentTerm || "‚Äì"}`,
    `Lead time: ${supplier.leadTime || "‚Äì"} days`,
    `Quote validity: ${supplier.validity || "‚Äì"} days`
  ];
  commercialLines.forEach((line) => {
    const wrapped = doc.splitTextToSize(line, maxW);
    wrapped.forEach((l) => {
      doc.text(l, left, y);
      y += 12;
    });
  });
  y += 8;

  if (c.otherRequirements) {
    doc.setFont("helvetica", "bold");
    doc.text("Other requirements", left, y);
    y += 12;
    doc.setFont("helvetica", "normal");
    const wrappedReq = doc.splitTextToSize(c.otherRequirements, maxW);
    wrappedReq.forEach((l) => {
      doc.text(l, left, y);
      y += 12;
    });
    y += 8;
  }

  // ---------- LINE ITEM TABLE ----------
  const items = currentRequest.items || [];
  const quoteItems = supplier.items || [];

  // Build table data
  const tableBody = items.map((item, idx) => {
    const qi = quoteItems[idx] || {};
    const sizeParts = [];
    if (item.diameter) sizeParts.push(item.diameter);
    if (item.wt)       sizeParts.push(item.wt + " wall");
    if (item.length)   sizeParts.push(item.length);
    const sizeText = sizeParts.join(" ¬∑ ") || "";

    const unitPrice =
      typeof qi.unitPrice === "number"
        ? `${currency} ${qi.unitPrice.toFixed(2)}`
        : "";
    const lineTotal =
      typeof qi.lineTotal === "number"
        ? `${currency} ${qi.lineTotal.toFixed(2)}`
        : "";

    return [
      item.line ?? idx + 1,
      item.description || "",
      item.grade || "",
      item.quantity ?? "",
      item.uom || "",
      sizeText || "",
      unitPrice,
      lineTotal
    ];
  });

  // ensure autoTable is available
  if (doc.autoTable) {
    doc.setFont("helvetica", "bold");
    doc.text("Line items", left, y);
    y += 6;

    doc.autoTable({
      startY: y + 6,
      head: [[
        "Line",
        "Description",
        "Grade",
        "Qty",
        "UoM",
        "Size (OD / WT / Len)",
        "Unit price",
        "Line total"
      ]],
      body: tableBody,
      styles: {
        fontSize: 8
      },
      headStyles: {
        fillColor: [51, 65, 85], // slate-ish
        textColor: 255
      },
      columnStyles: {
        0: { cellWidth: 30 },
        1: { cellWidth: 150 },
        2: { cellWidth: 40 },
        3: { cellWidth: 35 },
        4: { cellWidth: 35 },
        5: { cellWidth: 130 },
        6: { cellWidth: 60 },
        7: { cellWidth: 60 }
      },
      margin: { left }
    });

    y = doc.lastAutoTable.finalY + 16;
  } else {
    // Fallback: simple list if autoTable missing
    doc.text("Line items (table plugin not available)", left, y);
    y += 12;
    items.forEach((item, idx) => {
      const line = `${item.line ?? idx + 1}. ${item.description || ""} ‚Äì Qty ${
        item.quantity ?? ""
      } ${item.uom || ""}`;
      const wrapped = doc.splitTextToSize(line, maxW);
      wrapped.forEach((l) => {
        doc.text(l, left, y);
        y += 12;
      });
    });
    y += 8;
  }

  // ---------- TOTAL SUMMARY ----------
  doc.setFont("helvetica", "bold");
  const totalText =
    typeof supplier.total === "number"
      ? `${currency} ${supplier.total.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        })}`
      : "N/A";
  doc.text(`Estimated total value: ${totalText}`, left, y);
  y += 20;

  // ---------- FREE-TEXT RFP BODY (from lastRfpDraft, if you want it) ----------
  if (lastRfpDraft) {
    doc.setFont("helvetica", "bold");
    doc.text("Narrative RFP details", left, y);
    y += 14;
    doc.setFont("helvetica", "normal");
    const wrapped = doc.splitTextToSize(lastRfpDraft, maxW);
    wrapped.forEach((line) => {
      if (y > 760) {
        doc.addPage();
        y = 40;
      }
      doc.text(line, left, y);
      y += 12;
    });
    y += 16;
  }

  // ---------- SIGNATURES ----------
  if (y > 700) {
    doc.addPage();
    y = 60;
  }
  doc.setFont("helvetica", "bold");
  doc.text("Signatures", left, y);
  y += 14;
  doc.setFont("helvetica", "normal");
  doc.text(
    "Buyer signature: ______________________      Date: ____________",
    left,
    y
  );
  y += 20;
  doc.text(
    "Supplier signature: ____________________   Date: ____________",
    left,
    y
  );

  const filename = `RFP_${rfqId}.pdf`;
  doc.save(filename);
  $("pdf-modal").classList.add("hidden");
  $("pdf-modal").classList.remove("flex");
});


    // Copy link
    $("copy-link-btn").addEventListener("click", () => {
      const input = $("share-link-input");
      if (!input.value) return;
      input.select();
      try { document.execCommand("copy"); alert("Link copied to clipboard (demo)."); }
      catch { alert("Unable to copy automatically. Please copy manually."); }
    });

    // Structured table edits
    $("buyer-items-body").addEventListener("input", (e) => {
      if (!e.target.classList.contains("buyer-item-input")) return;
      const idx   = parseInt(e.target.dataset.index, 10);
      const field = e.target.dataset.field;
      if (!currentRequest || !currentRequest.items[idx]) return;
      let value = e.target.value;
      if (field === "quantity" && value !== "") {
        const n = Number(value);
        currentRequest.items[idx][field] = isNaN(n) ? null : n;
      } else {
        currentRequest.items[idx][field] = value;
      }
      renderSupplierRequest();
      renderSupplierPreview();
    });

    // Other requirements textarea
    $("buyer-other-req").addEventListener("input", (e) => {
      if (!currentRequest) return;
      currentRequest.commercial.otherRequirements = e.target.value;
    });

    // Supplier price inputs
    document.addEventListener("input", (e) => {
      if (!e.target.classList.contains("supplier-price-input")) return;
      const idx = parseInt(e.target.getAttribute("data-index"), 10);
      const val = e.target.value;
      const num = val === "" ? NaN : Number(val);
      supplierUnitPrices[idx] = num;
      updateSupplierTotalPreview();
      renderSupplierPreview();
    });

    // Project / package field listeners (EPC context)
    [
    { el: projectNameInput,    key: "projectName" },
    { el: projectClientInput,  key: "clientName" },
    { el: projectPackageInput, key: "packageId" },
    { el: projectRevisionInput,key: "revision" },
    { el: projectStageInput,   key: "stage" }
    ].forEach(({ el, key }) => {
    if (!el) return;
    el.addEventListener("input", (e) => {
        if (!currentRequest) {
        // If no RFQ yet, do nothing for now; we can tie this into "pending project"
        return;
        }
        if (!currentRequest.project) {
        currentRequest.project = {};
        }
        currentRequest.project[key] = e.target.value;
    });
    });

    // Supplier meta changes
    [
      "supplier-name-input",
      "supplier-currency-input",
      "supplier-leadtime-input",
      "supplier-payment-input",
      "supplier-validity-input",
      "supplier-notes-input"
    ].forEach(id => {
      const el = $(id);
      if (el) el.addEventListener("input", renderSupplierPreview);
    });

    // Supplier quote submit
    $("supplier-submit-btn").addEventListener("click", () => {
      if (!currentRequest) {
        alert("No active request. The buyer has not generated a product request yet.");
        return;
      }
      const { hasPrice, total } = computeSupplierTotal();
      if (!hasPrice) {
        alert("Please enter at least one unit price before submitting your quote.");
        return;
      }

      const name     = $("supplier-name-input")?.value.trim() || "Unnamed supplier";
      const currency = $("supplier-currency-input")?.value || "USD";
      const leadTime = $("supplier-leadtime-input")?.value.trim();
      const payment  =
        $("supplier-payment-input")?.value.trim() ||
        currentRequest.commercial.paymentTerm ||
        "";
      const validity = $("supplier-validity-input")?.value.trim();
      const notes    = $("supplier-notes-input")?.value.trim();
      const email    = $("supplier-email-input")?.value.trim();
      const phone    = $("supplier-phone-input")?.value.trim();

      const items = currentRequest.items.map((item, idx) => {
        const price = supplierUnitPrices[idx];
        const qty   = item.quantity ?? 0;
        const lineTotal =
          Number.isFinite(price) && qty != null ? (qty || 1) * price : NaN;
        return {
          line: item.line,
          unitPrice: Number.isFinite(price) ? price : null,
          quantity: item.quantity,
          lineTotal: isNaN(lineTotal) ? null : lineTotal
        };
      });

      const quote = {
        supplierName: name,
        currency,
        total,
        items,
        leadTime,
        payment,
        validity,
        notes,
        email,
        phone
      };

      supplierQuotes.push(quote);
     // persist quotes so buyer tabs (or the buyer who generated RFQ) can see them
     saveQuotesToStorage();

      const qCount = $("quotes-count");
      const qEmpty = $("quotes-empty");
      const qList  = $("quotes-list");
      if (qCount) qCount.textContent = supplierQuotes.length.toString();
      if (qEmpty && qList) {
        qEmpty.classList.add("hidden");
        qList.classList.remove("hidden");
      }
      renderQuotes();
      renderSupplierPreview();
      alert("Quote submitted to buyer (demo). Switch to Buyer view to see it.");
    });

    // Ensure we try to load an RFQ from URL/localStorage when the page opens
    window.addEventListener("load", initFromUrl);

    // Seed chat
    renderChat();
  </script>
</body>
</html>
