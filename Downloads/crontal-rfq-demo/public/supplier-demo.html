<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crontal · Supplier Quote Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { accent: '#5a7baa' }
        }
      }
    }
  </script>

  <style>
    /* Dark-ish background, same accent family as buyer demo */
    body {
      background-color: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .card {
      background-color: #1e293b;
      border-color: #334155;
    }

    .card-border {
      border-color: #334155;
    }

    .text-main {
      color: #f1f5f9;
    }

    .text-subtle {
      color: #cbd5e1;
    }

    .accent-pill {
      background-color: rgba(90, 123, 170, 0.18);
      border-color: #7fa1d6;
      color: #7fa1d6;
    }

    input,
    textarea,
    select {
      background-color: #0b1120 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
      font-size: 0.75rem;
    }

    input::placeholder,
    textarea::placeholder {
      color: #94a3b8 !important;
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-6 md:py-10 space-y-6">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-accent/10 border border-accent flex items-center justify-center">
          <span class="text-accent font-semibold text-lg">C</span>
        </div>
        <div>
          <div class="flex items-center gap-2">
            <h1 class="text-xl md:text-2xl font-semibold tracking-tight text-main">
              Crontal
            </h1>
            <span class="inline-flex items-center rounded-full border border-slate-600 px-2 py-0.5 text-[11px] uppercase tracking-wide text-subtle bg-slate-900/60">
              Supplier portal
            </span>
          </div>
          <p class="text-xs md:text-sm text-subtle mt-1">
            Review the buyer’s structured RFQ, enter your pricing and terms, and see how your quote will appear.
          </p>
        </div>
      </div>

      <div class="text-right text-xs text-subtle">
        <p class="uppercase tracking-wide text-[11px] text-slate-400">Mode</p>
        <p class="mt-0.5">Supplier · Quote submission</p>
      </div>
    </header>

    <!-- Main content: ONE COLUMN STACKED -->
    <main class="flex flex-col gap-5">
      <!-- RFQ details & line items -->
      <section class="space-y-4">
        <div class="card border rounded-2xl p-4 md:p-5 text-xs card-border">
          <div class="flex items-center justify-between gap-3 mb-2">
            <div>
              <h2 class="text-sm font-semibold text-main">Loaded RFQ</h2>
              <p class="text-[11px] text-subtle mt-1">
                This is the buyer’s structured request you’ve been invited to quote on.
              </p>
            </div>
            <div class="text-right text-[11px] text-subtle">
              <p class="uppercase tracking-wide text-slate-400">RFQ ID</p>
              <p id="rfq-id-label" class="mt-0.5 font-medium text-main">–</p>
            </div>
          </div>

          <div id="rfq-error" class="text-[11px] text-red-300 hidden">
            Unable to load RFQ. Please confirm that you opened the link from the buyer and that it hasn’t expired.
          </div>

          <div id="rfq-empty" class="text-[11px] text-subtle">
            Looking for RFQ details…
          </div>

          <div id="rfq-block" class="hidden space-y-3 mt-2">
            <!-- Summary -->
            <div class="rounded-xl bg-slate-900/70 border card-border p-3">
              <p class="uppercase tracking-wide text-[11px] text-slate-400 mb-1">
                Summary
              </p>
              <p id="rfq-summary" class="text-xs text-main"></p>
            </div>

            <!-- Commercial terms -->
            <div class="grid gap-3 md:grid-cols-3">
              <div class="rounded-xl bg-slate-900/70 border card-border p-3">
                <p class="uppercase tracking-wide text-[11px] text-slate-400">
                  Destination
                </p>
                <p id="rfq-destination" class="mt-1 text-xs text-main">–</p>
              </div>
              <div class="rounded-xl bg-slate-900/70 border card-border p-3">
                <p class="uppercase tracking-wide text-[11px] text-slate-400">
                  Incoterm
                </p>
                <p id="rfq-incoterm" class="mt-1 text-xs text-main">–</p>
              </div>
              <div class="rounded-xl bg-slate-900/70 border card-border p-3">
                <p class="uppercase tracking-wide text-[11px] text-slate-400">
                  Payment terms
                </p>
                <p id="rfq-payment" class="mt-1 text-xs text-main">–</p>
              </div>
            </div>

            <!-- Line items -->
            <div>
              <p class="uppercase tracking-wide text-[11px] text-slate-400 mb-1">
                Line items
              </p>
              <!-- Removed max-h so table can expand; still scrollable if needed -->
              <div class="rounded-xl border card-border bg-slate-900/60 overflow-x-auto overflow-y-auto">
                <table class="min-w-full text-[11px] text-main">
                  <thead class="bg-slate-800 text-slate-300 sticky top-0">
                    <tr>
                      <th class="px-3 py-2 text-left font-normal">Line</th>
                      <th class="px-3 py-2 text-left font-normal">Description</th>
                      <th class="px-3 py-2 text-left font-normal">Grade</th>
                      <th class="px-3 py-2 text-left font-normal">Size / Spec</th>
                      <th class="px-3 py-2 text-left font-normal">Qty</th>
                      <th class="px-3 py-2 text-left font-normal">UoM</th>
                      <th class="px-3 py-2 text-left font-normal">Unit price</th>
                    </tr>
                  </thead>
                  <tbody id="items-body" class="divide-y divide-slate-700">
                    <!-- injected -->
                  </tbody>
                </table>
              </div>
              <p class="mt-1 text-[11px] text-subtle">
                Enter unit prices in your working currency. The estimated total will update automatically.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Supplier meta + preview (full-width stacked) -->
      <section class="space-y-4">
        <!-- Supplier meta + totals -->
        <div class="card border rounded-2xl p-4 md:p-5 text-xs card-border space-y-3">
          <div class="flex items-center justify-between gap-3 mb-1">
            <div>
              <h3 class="text-sm font-semibold text-main">Your quotation</h3>
              <p class="text-[11px] text-subtle mt-1">
                Fill in your company info, lead time and commercial terms.
              </p>
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="uppercase tracking-wide text-[11px] text-slate-400">
                Supplier name
              </label>
              <input
                id="supplier-name-input"
                type="text"
                class="mt-1 w-full rounded-xl border px-3 py-1.5"
                placeholder="Example: Mill A · East Asia"
              />
            </div>
            <div>
              <label class="uppercase tracking-wide text-[11px] text-slate-400">
                Currency
              </label>
              <select
                id="supplier-currency-input"
                class="mt-1 w-full rounded-xl border px-3 py-1.5"
              >
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="CNY">CNY</option>
              </select>
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="uppercase tracking-wide text-[11px] text-slate-400">
                Contact email
              </label>
              <input
                id="supplier-email-input"
                type="email"
                class="mt-1 w-full rounded-xl border px-3 py-1.5"
                placeholder="sales@mill.com"
              />
            </div>
            <div>
              <label class="uppercase tracking-wide text-[11px] text-slate-400">
                Contact phone
              </label>
              <input
                id="supplier-phone-input"
                type="tel"
                class="mt-1 w-full rounded-xl border px-3 py-1.5"
                placeholder="+1 555 123 4567"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-3">
            <div>
              <label class="uppercase tracking-wide text-[11px] text-slate-400">
                Lead time (days)
              </label>
              <input
                id="supplier-leadtime-input"
                type="number"
                class="mt-1 w-full rounded-xl border px-3 py-1.5"
                placeholder="e.g. 30"
              />
            </div>
            <div>
              <label class="uppercase tracking-wide text-[11px] text-slate-400">
                Payment terms
              </label>
              <input
                id="supplier-payment-input"
                type="text"
                class="mt-1 w-full rounded-xl border px-3 py-1.5"
                placeholder="e.g. Net 30"
              />
            </div>
            <div>
              <label class="uppercase tracking-wide text-[11px] text-slate-400">
                Quote validity (days)
              </label>
              <input
                id="supplier-validity-input"
                type="number"
                class="mt-1 w-full rounded-xl border px-3 py-1.5"
                placeholder="e.g. 15"
              />
            </div>
          </div>

          <div>
            <label class="uppercase tracking-wide text-[11px] text-slate-400">
              Notes / conditions
            </label>
            <textarea
              id="supplier-notes-input"
              class="mt-1 w-full rounded-xl border px-3 py-2 h-20"
              placeholder="Enter any special conditions, MOQ, packaging, freight assumptions, etc."
            ></textarea>
          </div>

          <div class="flex items-center justify-between gap-2 mt-2">
            <p id="supplier-total-preview" class="text-[11px] text-subtle">
              No RFQ loaded.
            </p>
            <button
              id="supplier-submit-btn"
              class="inline-flex items-center gap-1 rounded-xl border border-accent bg-accent/10 px-3 py-1.5 text-[11px] text-accent font-medium hover:bg-accent/20 transition"
            >
              Submit quote (demo)
            </button>
          </div>
        </div>

        <!-- How buyer sees you -->
        <div class="card border rounded-2xl p-4 md:p-5 text-xs card-border space-y-2">
          <div class="flex items-center justify-between gap-3 mb-1">
            <div>
              <h3 class="text-sm font-semibold text-main">
                Buyer-facing preview
              </h3>
              <p class="text-[11px] text-subtle mt-1">
                A compact card summarizing your quote, similar to what the buyer will see.
              </p>
            </div>
          </div>

          <div id="preview-empty" class="text-[11px] text-subtle">
            Start entering unit prices and your meta info to see a live preview of your quote.
          </div>

          <div
            id="preview-card"
            class="hidden rounded-xl border accent-pill px-3 py-3 text-xs shadow-sm"
          >
            <div class="flex items-center justify-between gap-3">
              <div>
                <p id="preview-supplier-name" class="font-medium text-main"></p>
                <p id="preview-request-ref" class="mt-0.5 text-[11px] text-subtle"></p>
                <p id="preview-terms" class="mt-0.5 text-[11px] text-subtle"></p>
              </div>
              <div class="text-right text-[11px]">
                <p id="preview-total" class="text-accent font-semibold"></p>
                <p class="text-subtle">Est. total value</p>
              </div>
            </div>
            <p id="preview-notes" class="mt-2 text-[11px] text-main"></p>
          </div>

          <p class="mt-2 text-[11px] text-subtle">
            This page is a demo. In production, submitting the quote would send this data back to the buyer’s Crontal portal.
          </p>
        </div>
      </section>
    </main>
  </div>

  <script>
    const RFQ_STORAGE_PREFIX = "crontal-rfq-";
    const QUOTES_STORAGE_PREFIX = "crontal-quotes-";

    let currentRequest     = null;
    let supplierUnitPrices = [];
    let supplierQuotes     = []; // persist in-memory for this tab

    const $ = (id) => document.getElementById(id);

    function computeSupplierTotal() {
      if (!currentRequest) return { hasPrice: false, total: 0 };
      let total = 0;
      let hasPrice = false;

      currentRequest.items.forEach((item, idx) => {
        const price = supplierUnitPrices[idx];
        if (!Number.isFinite(price)) return;
        const qty = item.quantity ?? 0;
        total += (qty || 1) * price;
        hasPrice = true;
      });

      return { hasPrice, total };
    }

    function updateSupplierTotalPreview() {
      const label = $("supplier-total-preview");
      if (!label) return;
      if (!currentRequest) {
        label.textContent = "No RFQ loaded.";
        return;
      }

      const { hasPrice, total } = computeSupplierTotal();
      const currency = $("supplier-currency-input")?.value || "USD";

      if (!hasPrice) {
        label.textContent =
          "Fill in unit prices to see the estimated total value for this RFQ.";
        return;
      }

      label.textContent =
        "Estimated total: " +
        currency +
        " " +
        total.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
    }

    function renderPreviewCard() {
      const empty = $("preview-empty");
      const card  = $("preview-card");
      if (!empty || !card || !currentRequest) return;

      const { hasPrice, total } = computeSupplierTotal();
      if (!hasPrice) {
        card.classList.add("hidden");
        empty.textContent =
          "Start entering unit prices and your meta info to see a live preview of your quote.";
        return;
      }

      const supplierName = $("supplier-name-input")?.value || "Your company";
      const currency     = $("supplier-currency-input")?.value || "USD";
      const leadTime     = $("supplier-leadtime-input")?.value || "–";
      const payment      =
        $("supplier-payment-input")?.value ||
        currentRequest.commercial?.paymentTerm ||
        "–";
      const validity     = $("supplier-validity-input")?.value || "–";
      const notes        =
        $("supplier-notes-input")?.value ||
        "No special conditions provided.";

      empty.textContent = "";
      card.classList.remove("hidden");

      $("preview-supplier-name").textContent = supplierName;
      $("preview-request-ref").textContent =
        "Quote for " +
        (currentRequest.id || currentRequest.rfq_id || "RFQ") +
        " · " +
        (currentRequest.items?.[0]?.description || "stainless request");

      $("preview-terms").textContent =
        "Lead time: " +
        leadTime +
        " days · Payment: " +
        payment +
        " · Validity: " +
        validity +
        " days";

      $("preview-total").textContent =
        currency +
        " " +
        total.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });

      $("preview-notes").textContent = notes;
    }

    function mapBackendToCurrentRequestForSupplier(data) {
      const rfqId     = data.rfq_id || ("RFQ-" + Date.now());
      const lineItems = Array.isArray(data.line_items) ? data.line_items : [];
      const items = lineItems.map((li, idx) => {
        const size = li.size || {};
        const od   = size.outer_diameter || {};
        const wt   = size.wall_thickness || {};
        const len  = size.length || {};

        return {
          line: idx + 1,
          description: li.product_type || li.raw_description || `Line ${idx + 1}`,
          grade: li.material_grade || "",
          quantity: li.quantity ?? null,
          uom: li.unit || "",
          diameter: od.value != null ? `${od.value}${od.unit ? " " + od.unit : ""}` : "",
          wt: wt.value != null ? `${wt.value}${wt.unit ? " " + wt.unit : ""}` : "",
          length: len.value != null ? `${len.value}${len.unit ? " " + len.unit : ""}` : ""
        };
      });

      const first = lineItems[0] || {};
      const commercial = {
        destination: first.delivery_location || "",
        incoterm:    first.incoterm || "",
        paymentTerm: first.payment_terms || "",
        otherRequirements: Array.isArray(first.other_requirements)
          ? first.other_requirements.join("; ")
          : ""
      };

      return {
        id: rfqId,
        items,
        commercial
      };
    }


    function buildSupplierSummary(req) {
        if (!req || !Array.isArray(req.items) || !req.items.length) {
            return "No line items found in this RFQ.";
        }

        const items = req.items;
        const c = req.commercial || {};

        // Build condensed descriptions for the first few line items
        const itemPhrases = items.slice(0, 3).map((it, idx) => {
            const parts = [];

            // quantity + unit
            if (it.quantity != null) {
            parts.push(`${it.quantity} ${it.uom || ""}`.trim());
            }

            // grade + description/shape
            const descBits = [];
            if (it.grade) descBits.push(`Grade ${it.grade}`);
            if (it.shape) descBits.push(it.shape);
            if (it.description) descBits.push(it.description);
            if (descBits.length) parts.push(descBits.join(" "));

            // simple size spec
            const sizeBits = [];
            if (it.diameter) sizeBits.push(it.diameter);
            if (it.wt) sizeBits.push(it.wt + " wall");
            if (it.length) sizeBits.push(it.length);
            if (sizeBits.length) parts.push(sizeBits.join(" · "));

            return `${idx + 1}) ` + parts.join(" – ");
        });

        if (items.length > 3) {
            itemPhrases.push(`…plus ${items.length - 3} additional line item(s).`);
        }

        let summary =
            `Buyer is requesting ${items.length} line item(s), including:\n` +
            itemPhrases.join("\n");

        // Commercial terms
        const commercialParts = [];
        if (c.destination) {
            commercialParts.push(`deliver to ${c.destination}`);
        }
        if (c.incoterm) {
            commercialParts.push(c.incoterm);
        }
        if (c.paymentTerm) {
            commercialParts.push(`payment terms ${c.paymentTerm}`);
        }

        if (commercialParts.length) {
            summary +=
            "\n\nCommercial terms: " + commercialParts.join(" · ") + ".";
        }

        if (c.otherRequirements) {
            summary += `\n\nAdditional requirements: ${c.otherRequirements}`;
        }

        return summary;
        }



    function renderRFQ() {
      const idLabel  = $("rfq-id-label");
      const emptyEl  = $("rfq-empty");
      const errorEl  = $("rfq-error");
      const blockEl  = $("rfq-block");
      const summary  = $("rfq-summary");
      const destEl   = $("rfq-destination");
      const incoterm = $("rfq-incoterm");
      const payEl    = $("rfq-payment");
      const tbody    = $("items-body");

      if (!currentRequest) {
        idLabel.textContent = "–";
        emptyEl.classList.remove("hidden");
        errorEl.classList.add("hidden");
        blockEl.classList.add("hidden");
        return;
      }

      emptyEl.classList.add("hidden");
      errorEl.classList.add("hidden");
      blockEl.classList.remove("hidden");

      idLabel.textContent =
        currentRequest.id || currentRequest.rfq_id || "RFQ";

      const first = currentRequest.items?.[0] || {};
      const c     = currentRequest.commercial || {};

      summary.textContent = buildSupplierSummary(currentRequest);

      destEl.textContent    = c.destination || "–";
      incoterm.textContent  = c.incoterm || "–";
      payEl.textContent     = c.paymentTerm || "–";

      tbody.innerHTML = "";
      supplierUnitPrices = [];

      (currentRequest.items || []).forEach((it, idx) => {
        supplierUnitPrices.push(NaN);
        const specParts = [];
        if (it.diameter) specParts.push(it.diameter);
        if (it.wt)       specParts.push(it.wt + " wall");
        if (it.length)   specParts.push(it.length);
        const specText = specParts.join(" · ") || "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${it.line ?? idx + 1}</td>
          <td class="px-3 py-2">${it.description || "-"}</td>
          <td class="px-3 py-2">${it.grade || "-"}</td>
          <td class="px-3 py-2">${specText}</td>
          <td class="px-3 py-2">${it.quantity ?? "-"}</td>
          <td class="px-3 py-2">${it.uom || "-"}</td>
          <td class="px-3 py-2">
            <input
              type="number"
              step="0.01"
              class="supplier-price-input w-24 rounded-lg border px-2 py-1 text-[11px]"
              placeholder="0.00"
              data-index="${idx}"
            />
          </td>
        `;
        tbody.appendChild(tr);
      });

      updateSupplierTotalPreview();
      renderPreviewCard();
    }

    async function initFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const rfqId  = params.get("rfq_id");

      const emptyEl = $("rfq-empty");
      const errorEl = $("rfq-error");

      if (!rfqId) {
        emptyEl.textContent = "Missing RFQ ID in link. Please contact the buyer.";
        return;
      }

      try {
        const res = await fetch(`/api/rfqs/${encodeURIComponent(rfqId)}`);
        if (!res.ok) {
          emptyEl.classList.add("hidden");
          errorEl.classList.remove("hidden");
          return;
        }
        const data = await res.json();
        // Map backend RFQ -> currentRequest structure used by supplier demo
        currentRequest = mapBackendToCurrentRequestForSupplier(data);
        renderRFQ();
      } catch (err) {
        console.error("Failed to load RFQ:", err);
        emptyEl.classList.add("hidden");
        errorEl.classList.remove("hidden");
      }
    }


    // Price input listener
    document.addEventListener("input", (e) => {
      if (!e.target.classList.contains("supplier-price-input")) return;
      const idx = Number(e.target.getAttribute("data-index"));
      const val = e.target.value;
      const num = val === "" ? NaN : Number(val);
      supplierUnitPrices[idx] = num;
      updateSupplierTotalPreview();
      renderPreviewCard();
    });

    // Meta changes → update preview
    [
      "supplier-name-input",
      "supplier-currency-input",
      "supplier-leadtime-input",
      "supplier-payment-input",
      "supplier-validity-input",
      "supplier-notes-input"
    ].forEach((id) => {
      const el = $(id);
      if (el) el.addEventListener("input", renderPreviewCard);
    });

    // Submit button (demo only) — build quote object and persist for buyer
    $("supplier-submit-btn").addEventListener("click", async () => {
      if (!currentRequest) {
        alert("No active RFQ loaded. The buyer has not generated a product request yet.");
        return;
      }
      const { hasPrice, total } = computeSupplierTotal();
      if (!hasPrice) {
        alert("Please enter at least one unit price before submitting your quote.");
        return;
      }

      const name     = $("supplier-name-input")?.value.trim() || "Unnamed supplier";
      const currency = $("supplier-currency-input")?.value || "USD";
      const leadTime = $("supplier-leadtime-input")?.value.trim();
      const payment  =
        $("supplier-payment-input")?.value.trim() ||
        currentRequest.commercial.paymentTerm ||
        "";
      const validity = $("supplier-validity-input")?.value.trim();
      const notes    = $("supplier-notes-input")?.value.trim();
      const email    = $("supplier-email-input")?.value.trim();
      const phone    = $("supplier-phone-input")?.value.trim();

      const items = currentRequest.items.map((item, idx) => {
        const price = supplierUnitPrices[idx];
        const qty   = item.quantity ?? 0;
        const lineTotal =
          Number.isFinite(price) && qty != null ? (qty || 1) * price : NaN;
        return {
          line: item.line,
          unitPrice: Number.isFinite(price) ? price : null,
          quantity: item.quantity,
          lineTotal: isNaN(lineTotal) ? null : lineTotal
        };
      });

      const quote = {
        supplierName: name,
        currency,
        total,
        items,
        leadTime,
        payment,
        validity,
        notes,
        email,
        phone
      };

      const rfqId = currentRequest.id || currentRequest.rfq_id;
      try {
        const res = await fetch(`/api/rfqs/${encodeURIComponent(rfqId)}/quotes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(quote)
        });
        if (!res.ok) {
          const txt = await res.text();
          console.error("Submit quote error:", txt);
          alert("Failed to submit quote to buyer (server error).");
          return;
        }
        alert("Quote submitted to buyer. They can see it in their Crontal view.");
      } catch (err) {
        console.error("Submit quote error:", err);
        alert("Network error while submitting quote.");
      }
    });


    // Kick off
    initFromUrl();
  </script>
</body>
</html>
